<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>二维码渲染引擎集成测试</title>
    <style>
        body {
            font-family: "SF Pro Text", "PingFang SC", "Microsoft YaHei", sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2 {
            text-align: center;
            margin-bottom: 1rem;
        }
        .test-section {
            margin-bottom: 2rem;
            padding: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .qr-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .qr-item {
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            background-color: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .qr-preview {
            width: 200px;
            height: 200px;
            margin: 10px auto;
            border: 1px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .controls {
            margin: 1rem 0;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .color-input {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }
        .color-input input[type="color"] {
            margin-left: 8px;
        }
        button {
            padding: 8px 16px;
            border-radius: 4px;
            background: #4a90e2;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background: #3a80d2;
        }
        .console {
            background: #1c1c1e;
            color: #fff;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            max-height: 100px;
            overflow-y: auto;
            margin-top: 10px;
            font-size: 12px;
            text-align: left;
        }
        .console-message {
            margin: 2px 0;
        }
        .console-info {
            color: #5ac8fa;
        }
        .console-error {
            color: #ff3b30;
        }
        .console-success {
            color: #34c759;
        }
    </style>
</head>
<body>
    <h1>二维码渲染引擎集成测试</h1>
    <p>此页面测试所有类型的二维码生成器和渲染引擎的兼容性和颜色应用。</p>
    
    <div class="controls">
        <div class="color-input">
            <label for="foreground">前景色:</label>
            <input type="color" id="foreground" value="#000000">
        </div>
        <div class="color-input">
            <label for="background">背景色:</label>
            <input type="color" id="background" value="#FFFFFF">
        </div>
        <button id="regenerate">重新生成全部</button>
        <button id="download-all">下载全部PNG</button>
    </div>
    
    <div class="console" id="main-console"></div>
    
    <!-- 文本二维码测试 -->
    <div class="test-section">
        <h2>文本二维码测试</h2>
        <div class="qr-container" id="text-container"></div>
    </div>
    
    <!-- URL二维码测试 -->
    <div class="test-section">
        <h2>URL二维码测试</h2>
        <div class="qr-container" id="url-container"></div>
    </div>
    
    <!-- WiFi二维码测试 -->
    <div class="test-section">
        <h2>WiFi二维码测试</h2>
        <div class="qr-container" id="wifi-container"></div>
    </div>
    
    <!-- 加载依赖 -->
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest/umd/index.min.js"></script>
    <script src="../../src/generators/logo-manager.js"></script>
    <script src="../../src/generators/base-generator.js"></script>
    <script src="../../src/generators/text-generator.js"></script>
    <script src="../../src/generators/url-generator.js"></script>
    <script src="../../src/generators/zxing-generator.js"></script>
    
    <!-- 新渲染引擎 -->
    <script src="../../src/renderers/zxing/svgBuilder.js"></script>
    <script src="../../src/renderers/zxing/colorManager.js"></script>
    <script src="../../src/renderers/zxing/ZXingRenderer.js"></script>
    
    <script>
        // 控制台工具
        class ConsoleLogger {
            constructor(elementId) {
                this.container = document.getElementById(elementId);
            }
            
            log(message, type = 'info') {
                const item = document.createElement('div');
                item.className = `console-message console-${type}`;
                item.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                this.container.appendChild(item);
                this.container.scrollTop = this.container.scrollHeight;
                console.log(`[${type}] ${message}`);
            }
            
            clear() {
                this.container.innerHTML = '';
            }
        }
        
        // 测试管理器
        class TestManager {
            constructor() {
                this.console = new ConsoleLogger('main-console');
                this.foregroundColor = document.getElementById('foreground').value;
                this.backgroundColor = document.getElementById('background').value;
                this.testResults = {};
                
                // 绑定事件监听器
                document.getElementById('foreground').addEventListener('change', (e) => {
                    this.foregroundColor = e.target.value;
                });
                
                document.getElementById('background').addEventListener('change', (e) => {
                    this.backgroundColor = e.target.value;
                });
                
                document.getElementById('regenerate').addEventListener('click', () => {
                    this.runAllTests();
                });
                
                document.getElementById('download-all').addEventListener('click', () => {
                    this.downloadAllPNG();
                });
            }
            
            async runAllTests() {
                this.console.clear();
                this.console.log('开始执行所有测试...', 'info');
                
                try {
                    await this.runTextTests();
                    await this.runURLTests();
                    await this.runWiFiTests();
                    
                    this.console.log('所有测试完成', 'success');
                } catch (error) {
                    this.console.log(`测试执行出错: ${error.message}`, 'error');
                }
            }
            
            async runTextTests() {
                const container = document.getElementById('text-container');
                container.innerHTML = '';
                this.console.log('开始文本二维码测试', 'info');
                
                const testCases = [
                    { name: '短文本', content: 'Hello, World!' },
                    { name: '中文文本', content: '你好，世界！' },
                    { name: '长文本', content: '这是一段较长的测试文本，用于测试二维码生成器处理长文本的能力。This is a longer test text to verify the QR code generator\'s ability to handle lengthy content.' }
                ];
                
                for (const testCase of testCases) {
                    await this.createQRTest('text', testCase, container);
                }
            }
            
            async runURLTests() {
                const container = document.getElementById('url-container');
                container.innerHTML = '';
                this.console.log('开始URL二维码测试', 'info');
                
                const testCases = [
                    { name: 'HTTP URL', content: 'http://example.com' },
                    { name: 'HTTPS URL', content: 'https://example.com/path?query=test' },
                    { name: '无协议URL', content: 'example.com' }
                ];
                
                for (const testCase of testCases) {
                    await this.createQRTest('url', testCase, container);
                }
            }
            
            async runWiFiTests() {
                const container = document.getElementById('wifi-container');
                container.innerHTML = '';
                this.console.log('开始WiFi二维码测试', 'info');
                
                const testCases = [
                    { name: 'WPA2网络', ssid: 'TestWiFi', password: 'password123', encryption: 'WPA2' },
                    { name: '中文SSID', ssid: '测试WiFi', password: 'password123', encryption: 'WPA2' },
                    { name: '隐藏网络', ssid: 'HiddenWiFi', password: 'password123', encryption: 'WPA2', hidden: true }
                ];
                
                for (const testCase of testCases) {
                    await this.createQRTest('wifi', testCase, container);
                }
            }
            
            async createQRTest(type, testCase, container) {
                const itemElement = document.createElement('div');
                itemElement.className = 'qr-item';
                
                // 添加标题
                const title = document.createElement('h3');
                title.textContent = testCase.name;
                itemElement.appendChild(title);
                
                // 添加预览区域
                const preview = document.createElement('div');
                preview.className = 'qr-preview';
                itemElement.appendChild(preview);
                
                // 创建控制台区域
                const consoleElement = document.createElement('div');
                consoleElement.className = 'console';
                itemElement.appendChild(consoleElement);
                
                try {
                    // 生成二维码
                    let svgElement;
                    
                    // 创建通用渲染器
                    const renderer = new ZXingRenderer({
                        size: 200,
                        foreground: this.foregroundColor,
                        background: this.backgroundColor,
                        errorCorrectionLevel: 'H',
                        debug: true
                    });
                    
                    switch (type) {
                        case 'text':
                            this.logToElement(consoleElement, `生成文本二维码: ${testCase.content.substring(0, 20)}${testCase.content.length > 20 ? '...' : ''}`);
                            svgElement = await renderer.generate(testCase.content);
                            this.logToElement(consoleElement, '文本二维码生成成功', 'success');
                            break;
                            
                        case 'url':
                            this.logToElement(consoleElement, `生成URL二维码: ${testCase.content}`);
                            // 规范化URL
                            let url = testCase.content;
                            if (!url.match(/^https?:\/\//)) {
                                url = 'https://' + url;
                                this.logToElement(consoleElement, `规范化URL: ${url}`);
                            }
                            svgElement = await renderer.generate(url);
                            this.logToElement(consoleElement, 'URL二维码生成成功', 'success');
                            break;
                            
                        case 'wifi':
                            this.logToElement(consoleElement, `生成WiFi二维码: SSID=${testCase.ssid}, 加密=${testCase.encryption}`);
                            // 生成WiFi字符串
                            const wifiString = `WIFI:T:${testCase.encryption};S:${testCase.ssid};P:${testCase.password};H:${testCase.hidden ? 'true' : ''};;`;
                            this.logToElement(consoleElement, `WiFi字符串: ${wifiString}`);
                            svgElement = await renderer.generate(wifiString);
                            this.logToElement(consoleElement, 'WiFi二维码生成成功', 'success');
                            break;
                    }
                    
                    // 保存结果
                    const key = `${type}-${testCase.name}`;
                    this.testResults[key] = {
                        type,
                        testCase,
                        svg: svgElement
                    };
                    
                    // 显示二维码
                    preview.appendChild(svgElement);
                    
                    // 添加下载按钮
                    const downloadBtn = document.createElement('button');
                    downloadBtn.textContent = '下载PNG';
                    downloadBtn.onclick = async () => {
                        await this.downloadSingleQR(key, consoleElement);
                    };
                    itemElement.appendChild(downloadBtn);
                    
                } catch (error) {
                    preview.textContent = '生成失败: ' + error.message;
                    this.logToElement(consoleElement, `生成失败: ${error.message}`, 'error');
                }
                
                container.appendChild(itemElement);
            }
            
            async downloadSingleQR(key, consoleElement) {
                const result = this.testResults[key];
                if (!result) {
                    this.console.log(`找不到测试结果: ${key}`, 'error');
                    return;
                }
                
                try {
                    this.logToElement(consoleElement, '开始下载PNG...');
                    
                    const renderer = new ZXingRenderer({
                        size: 200,
                        foreground: this.foregroundColor,
                        background: this.backgroundColor,
                        debug: true
                    });
                    
                    let content;
                    if (result.type === 'wifi') {
                        const { ssid, password, encryption, hidden } = result.testCase;
                        content = `WIFI:T:${encryption};S:${ssid};P:${password};H:${hidden ? 'true' : ''};;`;
                    } else if (result.type === 'url') {
                        content = result.testCase.content;
                        if (!content.match(/^https?:\/\//)) {
                            content = 'https://' + content;
                        }
                    } else {
                        content = result.testCase.content;
                    }
                    
                    const pngUrl = await renderer.exportToPNG(content);
                    
                    const link = document.createElement('a');
                    link.href = pngUrl;
                    link.download = `qrcode-${result.type}-${result.testCase.name}.png`;
                    link.click();
                    
                    this.logToElement(consoleElement, 'PNG下载完成', 'success');
                } catch (error) {
                    this.logToElement(consoleElement, `下载失败: ${error.message}`, 'error');
                }
            }
            
            async downloadAllPNG() {
                this.console.log('开始下载所有PNG二维码...', 'info');
                
                for (const key in this.testResults) {
                    await this.downloadSingleQR(key);
                }
                
                this.console.log('所有PNG下载完成', 'success');
            }
            
            logToElement(element, message, type = 'info') {
                const item = document.createElement('div');
                item.className = `console-message console-${type}`;
                item.textContent = message;
                element.appendChild(item);
                element.scrollTop = element.scrollHeight;
            }
        }
        
        // 初始化测试管理器
        document.addEventListener('DOMContentLoaded', () => {
            const testManager = new TestManager();
            testManager.runAllTests();
        });
    </script>
</body>
</html> 