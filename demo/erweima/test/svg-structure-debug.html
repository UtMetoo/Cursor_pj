<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG结构调试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .debug-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 2rem 0;
        }
        .debug-item {
            border: 1px solid #ccc;
            padding: 1rem;
            border-radius: 8px;
        }
        .qr-preview {
            text-align: center;
            margin: 1rem 0;
        }
        .svg-code {
            background: #f5f5f5;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .console {
            background: #000;
            color: #0f0;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            margin: 2rem 0;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.85rem;
        }
        .element-info {
            background: #e3f2fd;
            padding: 0.5rem;
            margin: 0.5rem 0;
            border-radius: 4px;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <h1>SVG结构调试</h1>
    
    <div class="debug-container">
        <div class="debug-item">
            <h3>原始ZXing SVG</h3>
            <div class="qr-preview" id="original-qr"></div>
            <div class="svg-code" id="original-code"></div>
            <div id="original-info"></div>
        </div>
        
        <div class="debug-item">
            <h3>应用颜色后的SVG</h3>
            <div class="qr-preview" id="colored-qr"></div>
            <div class="svg-code" id="colored-code"></div>
            <div id="colored-info"></div>
        </div>
    </div>
    
    <div class="console" id="console"></div>

    <script src="https://unpkg.com/@zxing/library@0.21.3/umd/index.min.js"></script>
    <script src="../src/renderers/zxing/svgBuilder.js"></script>
    <script src="../src/renderers/zxing/colorManager.js"></script>

    <script>
        function log(msg) {
            const console = document.getElementById('console');
            console.innerHTML += new Date().toLocaleTimeString() + ': ' + msg + '\n';
            console.scrollTop = console.scrollHeight;
        }

        function analyzeElement(element, prefix = '') {
            const info = [];
            info.push(`${prefix}标签: ${element.tagName}`);
            
            // 获取所有属性
            const attrs = {};
            for (let attr of element.attributes) {
                attrs[attr.name] = attr.value;
            }
            info.push(`${prefix}属性: ${JSON.stringify(attrs)}`);
            
            // 获取计算样式
            if (element.style) {
                const styles = {};
                for (let prop of element.style) {
                    styles[prop] = element.style[prop];
                }
                if (Object.keys(styles).length > 0) {
                    info.push(`${prefix}内联样式: ${JSON.stringify(styles)}`);
                }
            }
            
            return info;
        }

        function displayElementInfo(svg, containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            // 分析SVG根元素
            const rootInfo = analyzeElement(svg);
            const rootDiv = document.createElement('div');
            rootDiv.className = 'element-info';
            rootDiv.innerHTML = `<strong>SVG根元素:</strong><br>${rootInfo.join('<br>')}`;
            container.appendChild(rootDiv);
            
            // 分析所有子元素
            const allElements = svg.querySelectorAll('*');
            allElements.forEach((el, index) => {
                const info = analyzeElement(el, `  `);
                const div = document.createElement('div');
                div.className = 'element-info';
                div.innerHTML = `<strong>元素${index + 1} (${el.tagName}):</strong><br>${info.join('<br>')}`;
                container.appendChild(div);
            });
        }

        async function runDebug() {
            try {
                // 等待依赖加载
                await new Promise(resolve => {
                    const check = () => {
                        if (window.ZXing) {
                            resolve();
                        } else {
                            setTimeout(check, 100);
                        }
                    };
                    check();
                });

                log('开始SVG结构调试...');

                // 1. 创建原始ZXing SVG
                log('创建原始ZXing SVG...');
                const writer = new ZXing.BrowserQRCodeSvgWriter();
                const originalSvg = writer.write('测试内容', 200, 200);
                
                // 显示原始SVG
                const originalClone = originalSvg.cloneNode(true);
                document.getElementById('original-qr').appendChild(originalClone);
                document.getElementById('original-code').textContent = originalSvg.outerHTML;
                displayElementInfo(originalSvg, 'original-info');
                
                log('原始SVG创建完成');

                // 2. 应用颜色
                log('应用颜色...');
                const colorManager = new ColorManager(true); // 启用调试
                colorManager.setForegroundColor('#FF0000');
                colorManager.setBackgroundColor('#FFFF00');
                
                const coloredSvg = originalSvg.cloneNode(true);
                colorManager.applyColors(coloredSvg, '#FF0000', '#FFFF00');
                
                // 显示应用颜色后的SVG
                document.getElementById('colored-qr').appendChild(coloredSvg);
                document.getElementById('colored-code').textContent = coloredSvg.outerHTML;
                displayElementInfo(coloredSvg, 'colored-info');
                
                log('颜色应用完成');

                // 3. 手动测试不同的颜色应用方法
                log('测试手动颜色应用...');
                const manualSvg = originalSvg.cloneNode(true);
                
                // 方法1: 直接修改所有元素的fill属性
                const allElements = manualSvg.querySelectorAll('*');
                log(`找到 ${allElements.length} 个元素`);
                
                allElements.forEach((el, index) => {
                    const currentFill = el.getAttribute('fill');
                    log(`元素${index}: ${el.tagName}, fill=${currentFill}`);
                    
                    // 如果是黑色或没有fill属性，改为红色
                    if (!currentFill || currentFill === '#000000' || currentFill === '#000' || currentFill === 'black') {
                        el.setAttribute('fill', '#FF0000');
                        log(`  -> 修改为红色`);
                    }
                });
                
                // 方法2: 添加强制样式
                const style = document.createElementNS("http://www.w3.org/2000/svg", "style");
                style.textContent = `
                    * { fill: #FF0000 !important; }
                    svg { background-color: #FFFF00 !important; }
                `;
                manualSvg.insertBefore(style, manualSvg.firstChild);
                
                log('手动颜色应用完成');
                
                // 创建第三个测试区域显示手动修改的结果
                const manualContainer = document.createElement('div');
                manualContainer.className = 'debug-item';
                manualContainer.innerHTML = `
                    <h3>手动修改颜色的SVG</h3>
                    <div class="qr-preview"></div>
                    <div class="svg-code"></div>
                `;
                
                manualContainer.querySelector('.qr-preview').appendChild(manualSvg);
                manualContainer.querySelector('.svg-code').textContent = manualSvg.outerHTML;
                
                document.querySelector('.debug-container').appendChild(manualContainer);
                
                log('所有调试测试完成！');
                
            } catch (error) {
                log('调试失败: ' + error.message);
                console.error(error);
            }
        }

        window.addEventListener('load', runDebug);
    </script>
</body>
</html> 