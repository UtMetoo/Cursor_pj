<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最终功能验证测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-result {
            margin: 1rem 0;
            padding: 1rem;
            border-radius: 8px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .qr-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }
        .qr-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
        }
        .qr-item h3 {
            margin: 0 0 1rem 0;
            font-size: 1rem;
        }
        .console {
            background: #1c1c1e;
            color: #fff;
            padding: 1rem;
            border-radius: 8px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            margin: 2rem 0;
        }
        .summary {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 2rem 0;
        }
    </style>
</head>
<body>
    <h1>最终功能验证测试</h1>
    
    <div id="status" class="test-result info">
        <h3>测试状态</h3>
        <p>正在初始化...</p>
    </div>
    
    <div id="qr-results" class="qr-grid"></div>
    
    <div class="console" id="console"></div>
    
    <div id="summary" class="summary"></div>

    <!-- 加载ZXing库 -->
    <script src="https://unpkg.com/@zxing/library@0.21.3/umd/index.min.js"></script>
    
    <!-- 加载组件 -->
    <script src="../src/renderers/zxing/svgBuilder.js"></script>
    <script src="../src/renderers/zxing/colorManager.js"></script>
    <script src="../src/renderers/zxing/ZXingRenderer.js"></script>
    <script src="../src/generators/logo-manager.js"></script>
    <script src="../src/renderers/adapters/legacyAdapter.js"></script>

    <script>
        // 测试统计
        let testStats = {
            total: 0,
            passed: 0,
            failed: 0
        };

        // 日志函数
        function log(message, type = 'info') {
            const console = document.getElementById('console');
            const line = document.createElement('div');
            line.style.color = type === 'error' ? '#ff6b6b' : 
                              type === 'success' ? '#51cf66' : 
                              type === 'warning' ? '#ffd43b' : '#74c0fc';
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            console.appendChild(line);
            console.scrollTop = console.scrollHeight;
        }

        // 更新状态
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.className = `test-result ${type}`;
            status.innerHTML = `<h3>测试状态</h3><p>${message}</p>`;
        }

        // 创建二维码显示项
        function createQRItem(title, element, status) {
            const item = document.createElement('div');
            item.className = 'qr-item';
            
            const titleElem = document.createElement('h3');
            titleElem.textContent = title;
            item.appendChild(titleElem);
            
            if (element) {
                item.appendChild(element);
            }
            
            const statusElem = document.createElement('p');
            statusElem.textContent = status;
            statusElem.style.color = status.includes('✅') ? '#155724' : '#721c24';
            item.appendChild(statusElem);
            
            return item;
        }

        // 等待依赖加载
        function waitForDependencies() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                const check = () => {
                    attempts++;
                    if (window.ZXing && window.ZXingRenderer) {
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('依赖加载超时'));
                    } else {
                        setTimeout(check, 100);
                    }
                };
                
                check();
            });
        }

        // 核心功能测试
        async function runValidationTests() {
            try {
                updateStatus('等待依赖加载...', 'info');
                await waitForDependencies();
                
                updateStatus('开始功能验证测试...', 'info');
                log('开始最终验证测试', 'info');
                
                const tests = [
                    {
                        name: '文本二维码',
                        content: '这是一个测试文本',
                        options: { size: 200 }
                    },
                    {
                        name: 'URL二维码',
                        content: 'https://github.com',
                        options: { size: 200 }
                    },
                    {
                        name: 'WiFi二维码',
                        content: 'WIFI:T:WPA;S:TestNetwork;P:password123;;',
                        options: { size: 200 }
                    },
                    {
                        name: '彩色二维码',
                        content: '彩色二维码测试',
                        options: { 
                            size: 200,
                            foreground: '#FF6B6B',
                            background: '#F1F3F4'
                        }
                    },
                    {
                        name: '圆角二维码',
                        content: '圆角效果测试',
                        options: { 
                            size: 200,
                            cornerRadius: 8
                        }
                    },
                    {
                        name: '带Logo二维码',
                        content: '带Logo的二维码',
                        options: { 
                            size: 200,
                            logo: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiByeD0iOCIgZmlsbD0iIzAwN0FGRiIvPgo8cGF0aCBkPSJNMjAgMTBMMjUgMTVIMjJWMjVIMThWMTVIMTVMMjAgMTBaIiBmaWxsPSJ3aGl0ZSIvPgo8L3N2Zz4K',
                            logoSize: 0.25
                        }
                    }
                ];

                testStats.total = tests.length;
                const resultsContainer = document.getElementById('qr-results');
                
                for (const test of tests) {
                    try {
                        log(`测试 ${test.name}...`, 'info');
                        
                        // 添加Logo测试的特殊调试
                        if (test.options && test.options.logo) {
                            log(`Logo配置: ${JSON.stringify({
                                logo: test.options.logo.substring(0, 50) + '...',
                                logoSize: test.options.logoSize
                            })}`, 'info');
                        }
                        
                        const renderer = new ZXingRenderer(test.options);
                        
                        // 为彩色二维码启用调试模式
                        if (test.name === '彩色二维码' && renderer.colorManager) {
                            renderer.colorManager.debug = true;
                            log(`启用 ${test.name} 调试模式`, 'info');
                        }
                        
                        const qrElement = await renderer.generate(test.content);
                        
                        if (qrElement && qrElement.tagName === 'svg') {
                            // 检查Logo是否成功添加
                            if (test.options && test.options.logo) {
                                const logoElements = qrElement.querySelectorAll('image, .logo-image');
                                const logoBackgrounds = qrElement.querySelectorAll('.logo-background');
                                log(`Logo检查: 图片元素=${logoElements.length}, 背景元素=${logoBackgrounds.length}`, 'info');
                                
                                if (logoElements.length === 0) {
                                    log(`警告: ${test.name} 未找到Logo图片元素`, 'warning');
                                }
                            }
                            
                            testStats.passed++;
                            const item = createQRItem(test.name, qrElement, '✅ 生成成功');
                            resultsContainer.appendChild(item);
                            log(`${test.name} 生成成功`, 'success');
                        } else {
                            throw new Error('生成的元素无效');
                        }
                        
                    } catch (error) {
                        testStats.failed++;
                        const item = createQRItem(test.name, null, `❌ 生成失败: ${error.message}`);
                        resultsContainer.appendChild(item);
                        log(`${test.name} 生成失败: ${error.message}`, 'error');
                    }
                }
                
                // 更新总结
                updateSummary();
                
                if (testStats.failed === 0) {
                    updateStatus('所有功能验证通过！', 'success');
                    log('所有功能验证通过！', 'success');
                } else {
                    updateStatus(`验证完成，${testStats.failed} 项测试失败`, 'error');
                    log(`验证完成，${testStats.failed} 项测试失败`, 'error');
                }
                
            } catch (error) {
                updateStatus(`验证过程出错: ${error.message}`, 'error');
                log(`验证过程出错: ${error.message}`, 'error');
            }
        }

        // 更新测试总结
        function updateSummary() {
            const summary = document.getElementById('summary');
            const successRate = Math.round((testStats.passed / testStats.total) * 100);
            
            summary.innerHTML = `
                <h3>验证结果总结</h3>
                <p><strong>总计:</strong> ${testStats.total} 项测试</p>
                <p><strong>通过:</strong> ${testStats.passed} 项</p>
                <p><strong>失败:</strong> ${testStats.failed} 项</p>
                <p><strong>成功率:</strong> ${successRate}%</p>
                <p><strong>状态:</strong> ${testStats.failed === 0 ? '✅ 所有功能正常' : '❌ 存在问题需要修复'}</p>
            `;
        }

        // 页面加载完成后运行测试
        window.addEventListener('load', runValidationTests);
    </script>
</body>
</html> 